name: CI

on: [push, pull_request]

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        services:
            mongodb:
                image: mongo:4.4
                ports:
                    - 27017:27017

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Use Node.js 16.18.0
              uses: actions/setup-node@v2
              with:
                  node-version: 16.18.0

            - name: Setup Playwright
              uses: microsoft/playwright-github-action@v1

            - name: Check folder location
              run: ls

            - name: Install backend dependencies
              run: cd backend && npm ci
              env:
                  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

            - name: Install frontend dependencies
              run: cd frontend && npm ci
              env:
                  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

            - name: Install Playwright browsers
              run: npx playwright install
              env:
                  PLAYWRIGHT_BROWSERS_PATH: 0

            - name: Start backend server
              run: cd backend && npm run start &
              env:
                  MONGO_URL: mongodb://localhost:27017

            - name: Start frontend server
              run: cd frontend && npm run start &

            - name: Run tests
              run: cd frontend/tests && npx playwright test
